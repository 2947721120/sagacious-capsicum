{{!
    Copyright (C) 2014 Google Inc., authors, and contributors <see AUTHORS file>
    Licensed under http://www.apache.org/licenses/LICENSE-2.0 <see LICENSE file>
    Created By: sasmita
    Maintained By: sasmita
}}


<ul class="tree-structure new-tree dashboard-tree task-tree">
  {{#each filtered_list}}
    <li class="tree-item item-list" {{addclass "t-" instance.status}} {{addclass "t-" instance.overdue}} data-object-id="{{instance.id}}" data-object-type="{{instance.class.table_singular}}" {{#instance}}{{data 'model'}}{{/instance}}> 
      <div class="item-main" {{data 'model'}}>
        <div class="openclose">
          <div class="item-wrap">
            <div class="row-fluid">
              <div class="span12">
                <ul class="tree-action-list tasks-action">
                  <li> <!-- number of comment count -->
                    {{#with_mapping_count instance 'cycle_task_entries'}}
                    <span class="counter" rel="tooltip" data-placement="left" data-original-title="# of comments">
                      <i class="grcicon-comment"></i>
                      <strong class="error">{{count}}</strong>
                    </span>
                    {{/with_mapping_count}}
                  </li>
                  <li> <!-- due date -->
                    <span rel="tooltip" data-placement="top" {{#is_overdue instance.end_date instance.status}}class="error"{{/is_overdue}} data-original-title="Due On">
                      <i class="grcicon-history-{{#is_overdue instance.end_date instance.status}}red{{else}}color{{/if overdue_warning}}"></i>
                      {{localize_date instance.end_date}}
                    </span>
                  </li>
                  {{#using cycle=instance.cycle}}
                    {{#if_equals cycle.is_current true}}
                    <li> <!-- buttons -->
                      <div class="request-control" {{ (el) -> $(el).bind('inserted', function() { el.ggrc_controllers_quick_form({ instance : el.closest('.item-list').data('model')}); }); }}>
                        {{#if_equals instance.status 'Assigned'}}
                          <button class="btn btn-mini btn-info change-task-status {{instance._disabled}}" data-openclose="open" data-name="status" data-value="InProgress">Start</button>
                        {{/status}}
                        {{#if_equals instance.status 'InProgress'}}
                          <button class="btn btn-mini btn-draft change-task-status {{instance._disabled}}" data-name="status" data-value="Finished">Finish</button>
                        {{/if_equals}}
                        {{#if_equals instance.status 'Declined'}}
                          <button class="btn btn-mini btn-draft change-task-status {{instance._disabled}}" data-name="status" data-value="Finished">Finish</button>
                        {{/if_equals}}
                        {{#if_equals instance.status 'Finished'}}
                          <button class="btn btn-mini btn-danger change-task-status {{instance._disabled}}" data-name="status" data-value="Declined">Decline</button>
                          <button class="btn btn-mini btn-success change-task-status {{instance._disabled}}" data-openclose="close" data-name="status" data-value="Verified">Verify</button>
                        {{/status}}
                        {{#if_equals instance.status 'Verified'}}
                          <span class="task-done">
                            <em>Verified</em>
                          </span>
                        {{/if_equals}}
                        {{#instance._undo.0}}
                          <a href="javascript://" data-name="status" data-value="{{instance._undo.0}}" data-undo="true" class="undo {{instance._disabled}}">Undo</a>
                        {{/instance._undo.0}}
                      </div>
                    </li>
                    {{/if_equals}}
                  {{/using}}
                </ul>
                <div class="item-data">
                  <span class="status-label status-draft"></span>
                  <div class="tree-title-area w-status">
                    <a href="#">{{instance.title}}</a>
                    <ul class="item-util">
                      <li>
                        {{#using cycle=instance.cycle}}
                          {{#using workflow=cycle.workflow}}
                            Workflow: <a href="{{workflow.viewLink}}#current_widget">{{workflow.title}}</a>
                          {{/using}}
                        {{/using}}
                      </li>
                      <li>
                        {{#using instance=instance.cycle_task_group_object}}
                          {{#using object=instance.object}}
                            {{#if object.type}}
                              {{object.type}} : <a href="{{object.viewLink}}">{{firstnonempty object.title ''}}</a>
                            {{/if}}
                          {{/using}}
                        {{/using}}
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 2tier expanded info -->
      <div class="tier-2-info item-content">
        <div class="tier-2-info-content">
          <div class="details-wrap">
            <a class="btn btn-small btn-draft dropdown-toggle" href="#" data-toggle="dropdown"><i class="grcicon-setup-color"></i></a>
            <ul class="dropdown-menu" aria-labelledby="drop1" role="menu">
              {{#is_allowed 'update' instance context='for'}}
              <li>
                <a href="javascript://"
                    data-object-singular-override="Task for current Workflow Cycle"
                    data-toggle="modal-ajax-form"
                    data-modal-reset="reset"
                    data-modal-class="modal-wide"
                    data-object-singular="{{instance.class.model_singular}}"
                    data-object-plural="{{instance.class.table_plural}}"
                    data-object-id="{{instance.id}}">
                  <i class="grcicon-edit"></i>
                  Edit Task
                </a>
              </li>
              {{/is_allowed}}
            </ul>
          </div>
          <div class="tier-content">
            
            <div class="row-fluid wrap-row">
              <div class="span12">
                {{#if_helpers '\
                  #if_equals' instance.task_type 'text' '\
                  or #if_equals' instance.task_type "" '\
                  or #if_null' instance.task_type}}
                  <h6>Task details</h6>
                  <div class="tree-description">
                    {{{firstnonempty instance.description 'No additional details'}}}
                  </div>
                {{/if_helpers}}
                {{#if_equals instance.task_type 'menu'}}
                  <h6>Response Options</h6>
                  {{! here we need to start a quick form or other componenet}}
                  <ggrc-quick-update instance="instance">
                    <select name="selected_response_options.0" {{^if_can_edit_response instance instance.status}}disabled="disabled"{{/if}}>
                      {{#each instance.response_options}}
                        <option value="{{.}}" {{#if_equals instance.selected_response_options.0 this}}selected="selected"{{/if_equals}}>{{.}}</option>
                      {{/each}}
                    </select>
                  </ggrc-quick-update>
                {{/if_equals}}
                {{#if_equals instance.task_type 'checkbox'}}
                  <h6>Response Options</h6>
                  <ggrc-quick-update instance="instance">
                    {{#each instance.response_options}}
                    <div class="row-fluid">
                      <div class="span12">
                        <input type="checkbox" {{^if_can_edit_response instance instance.status}}disabled="disabled"{{/if}} multiple="multiple" name="selected_response_options" value="{{.}}" {{#in_array this instance.selected_response_options}}checked="checked"{{/in_array}}> {{.}}
                      </div>
                    </div>
                    {{/each}}
                  </ggrc-quick-update>
                {{/if_equals}}
                <br>
              </div>
            </div><!-- row-fluid end -->

            <div class="row-fluid wrap-row">
              <div class="span6">
                <h6>Assignee</h6>
                {{#if_workflow_assignee_privileges instance}}
                <div {{#instance}}{{data 'model'}}{{/instance}} {{ (el) -> el.ggrc_controllers_quick_form({ instance : el.data('model')}); }}>
                  {{#using contact=instance.contact}}
                    <div class="objective-selector">
                      <input type="text" name="contact.name" data-lookup="Person" data-params="Person:is_enabled=1" class="search-icon input-block-level" {{#if_equals instance.status 'Verified'}}disabled="disabled"{{/if}} placeholder="Choose Assignee" value="{{firstnonempty contact.name contact.email ''}}">
                    </div>
                  {{/using}}
                </div>
                {{else}}
                  {{#using contact=instance.contact}}
                  <div>{{firstnonempty contact.name contact.email ''}}</div>
                  {{/using}}
                {{/if_workflow_assignee_privileges}}
              </div>
              <div class="span6">
                <h6>Starts/Ends</h6>
                {{instance.start_date}} / {{instance.end_date}}
              </div>
            </div><!-- row-fluid end -->

            <!--  this is the child option which is true all the time -->
            {{#using entries=instance.cycle_task_entries}}
            <div class="row-fluid wrap-row">
              <div class="span12">
                <h6>Comments ({{entries.length}})</h6>
                <ul class="entry-list">
                  {{#each entries}}
                  {{#using comment=this}}
                    <li>
                      <span class="status-label status-draft"></span>
                      <div class="w-status">
                        {{{comment.description}}}
                        <!-- May be we should add upload to g-drive golder-->
                        <span class="entry-author">Modified by {{#using person=comment.modified_by}}{{{render '/static/mustache/people/popover.mustache' person=person}}}{{/using}} on {{date comment.created_at}}</span>
                      </div>
                      <div class="entry-actions pull-right">
                        <a class="dropdown-toggle" href="#" data-toggle="dropdown"><i class="grcicon-setup-color"></i></a>
                        <ul class="dropdown-menu" aria-labelledby="drop1" role="menu">
                          {{^if_equals instance.status 'Verified'}}
                          <li>
                            <a href="javascript://" data-toggle="modal-ajax-form" data-modal-reset="reset" data-modal-class="modal-wide" data-object-singular="CycleTaskEntry" data-object-plural="{{comment.class.table_plural}}" data-object-id="{{comment.id}}">
                              <i class="grcicon-edit"></i>
                              Edit Comment
                            </a>
                          </li>
                          {{/if_equals}}
                        </ul>
                      </div><!-- entry-actions end -->
                    </li>
                  {{/using}}
                  {{/each}}
                </ul>
                <ul class="entry-list">
                  {{^if_equals instance.status 'Verified'}}
                  {{#using cycle=instance.cycle}}
                  {{#if cycle.is_current}}
                  <li>
                    <a href="javascript://"
                      class="btn btn-primary btn-mini section-create"
                      data-object-singular-override="Comment"
                      data-toggle="modal-ajax-form"
                      data-modal-reset="reset"
                      data-dirty="#regulations, #combo"
                      data-route="regulations"
                      data-modal-class="modal-wide"
                      data-object-singular="CycleTaskEntry"
                      data-object-plural="cycle_task_entries"
                      data-object-params='{ "cycle_task_group_object_task": {{instance.id}}, "cycle": {{instance.cycle.id}}, "context": {{instance.context.id}} }'>
                      Add Comment
                    </a>
                  </li>
                  {{/if}}
                  {{/using}}
                  {{/if_equals}}
                </ul>
              </div>
            </div><!-- row-fluid end -->
            {{/using}}

          </div><!-- tier-content end -->
        </div><!-- tier-2-info-content end -->
      </div><!-- tier-2-info end -->
    </li>
  {{/each}}
</ul><!-- tree-structure end -->
