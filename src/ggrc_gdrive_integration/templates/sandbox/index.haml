-extends 'layouts/dashboard.haml'

-block extra_javascript
  GGRC.page_object = ={ instance_json()|safe };
  GGRC.permissions = ={ permissions_json()|safe };
  GGRC.config = ={config_json()|safe};

-block header
  %script#folder_tmpl{ 'type' : 'text/mustache' }
    -raw
      <h3> Current folder : {{#if_equals parent ''}}Root folder{{else}}{{parent.name}}{{/if_equals}} </h3>
      <a href="javascript://" class='list-folders go-up' style='{{#if_equals parent ''}}display: none{{/if_equals}}' data-folder-id="{{parent_id}}">Go up one level</a>
      <ul class="folders-list">
        {{#list}}
        <li> 
          <a class="list-folders" href='javascript://' {{data 'folder'}}>
          {{name}}
          </a>
          |
          <a href="{{url}}" target="_blank">Go to folder</a>
        </li>
        {{/list}} 
      </ul>
    -endraw

  %script#file_tmpl{ 'type' : 'text/mustache' }
    -raw
      {{#this}}
      <li> 
        <a href="{{url}}" target="_blank">{{name}}</a>
      </li>
      {{/this}} 
    -endraw

  %script#permissions_tmpl{ 'type' : 'text/mustache' }
    -raw
      {{#if_equals status -1}}
        Error: {{message}}
      {{else}}
      <h3>permissions</h3>
      {{shareablepermissions}}
      <h3>users</h3>
      {{viewers}}
      {{/if_equals}}
    -endraw

-block main
  .clearfix
    .object-area
      %h2 Folders on GDrive
      %div#folders{"style" : "border : 1px solid black; width: 400px"} &nbsp;

      %h2 Files in the current folder
      %div#files{"style" : "border : 1px solid black; width: 400px"} &nbsp;

      %h2 Permissions on the current folder
      %div#permissions{"style" : "border : 1px solid black; width: 400px"} &nbsp;

      %br
      %a#load_top.list-folders{ 'href' : 'javascript://', 'style' : 'display:none'} List top level folders

      %h2 Add a folder
      %div#add_folder{'style' : 'border : 1px solid black; width : 400px'}
        %form{ 'action' : 'javascript://'}
          %label{ 'for' : '#foldername'} Folder name
          %input#foldername{ 'type' : 'text', 'name' : 'name', 'value' : ''}
          %input.add-folder{ 'type' : 'button', 'value' : 'Add folder'}
  :javascript
    $(function() {
      var folderstack = [GGRC.config.GDRIVE_ROOT_FOLDER];
      var lblist = null;
      var folderspinner, filespinner;
      $(document.body).on("click", ".list-folders", function(ev) {
        var folder = $(this).data('folder')
        , folder_id = folder ? folder.id : GGRC.config.GDRIVE_ROOT_FOLDER;
        if($(this).is(".go-up")) {
          folderstack.shift();
          folder_id = folderstack[0];
        } else {
          folderstack.unshift(folder_id);
        }
        $("#folders").html((folderspinner = new Spinner({ length : 5, width : 2, radius : 2, y: 14, x: 15}).spin()).el).append("&nbsp;");
        can.view(
          "#folder_tmpl"
          , GGRC.Models.GDriveFolder.findAll({parentfolderid : folder_id})
            .then(function(list) {
              if(list.status && list.status() === 0) {
              } else {
                lblist = list;
                return { 
                  list : list, 
                  parent : folder_id === GGRC.config.GDRIVE_ROOT_FOLDER ? null : folder
                };
              }
            }, function(xhr, status) {
              folderspinner.stop();
              $("folders").html("error: " + xhr.statusText);
              return new $.Deferred().reject();
            })
        ).done(function(frag) {
          $("#folders").html(frag).data("folder-id", folder_id);
        });

        $("#files").html((filespinner = new Spinner({ length : 5, width : 2, radius: 2}).spin()).el).append("&nbsp;");
        can.view(
          "#file_tmpl"
          , GGRC.Models.GDriveFile.findAll({id : folder_id}).fail(function(e) {
            filespinner.stop();
            $("#files").html("error: " + e.statusText || JSON.stringify(e));
            return new $.Deferred().reject();
          })
        ).done(function(frag) {
          $("#files").html(frag).data("folder-id", folder_id);
        });

        $("#permissions").html((filespinner = new Spinner({ length : 5, width : 2, radius: 2}).spin()).el).append("&nbsp;");
        can.view(
          "#permissions_tmpl"
          , GGRC.Models.GDriveFolderPermission.findAll({id : folder_id}).fail(function(e) {
            filespinner.stop();
            $("#permissions").html("error: " + e.statusText || JSON.stringify(e));
            return new $.Deferred().reject();
          })
        ).done(function(frag) {
          $("#permissions").html(frag).data("folder-id", folder_id);
        });
      }).on("click", ".add-folder", function(ev) {
        var that = this;
        new GGRC.Models.GDriveFolder({ name : $(this).closest("form").find("[name=name]").val(), parentfolderid : folderstack[0], allowduplicatenames : false })
        .save()
        .fail(function(xhr, status){
          $(document.body).trigger("ajax:flash", { error : [status]});
        })
        .done(function(noob) {
          lblist.push(noob);
          $(that).closest("form").reset();
        })
      });

      $("#load_top").click();

    });